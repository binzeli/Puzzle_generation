import os
import replicate
from llama_index.core import SimpleDirectoryReader
from llama_index.multi_modal_llms.openai import OpenAIMultiModal
os.environ["REPLICATE_API_TOKEN"] = "r8_LMZoyy9Hh5CebwLEVDl3Sg8KWj5rxvB3xv6YQ"
os.environ['OPENAI_API_KEY'] = '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'




def generate_response(message, obj_pos):

    current_dir = os.path.dirname(__file__)
    parent_dir = os.path.dirname(current_dir)

    image_documents = SimpleDirectoryReader(os.path.join(parent_dir, "frames")).load_data()

    openai_mm_llm = OpenAIMultiModal(
            model="gpt-4o-2024-05-13", api_key='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', max_new_tokens=1500
        )

    tools = ['Ramp: simulate inclined surfaces over which balls can roll or slide down to change its direction to the left or right. This is used when you want a gradual change in direction or need to guide the ball smoothly over a distance. Length of the ramp can be 10, 14, 18. You must say whether the ball needs to move to the left or right.', 
             'Fixed_Hexagon:  The hexagon will redirect the ball toward another direction. This cannot be placed when there is no other tools and when the blue ball is falling vertically down.', 
             'Cannon: This is used when you need to shoot the ball in a specific direction.']

    response_1 = openai_mm_llm.complete(
            prompt=f"The images show the ball's moving path over time. You are a player agent and your task is to place tool to help the blue ball push the red ball to the goal. The blue ball is initially falling down due to gravity. The red ball and the goal stand still on their floors. This is a 2D physics game so you need to keep in mind that balls move following rule of physics. \
            The tool list is {tools}, but keep in mind that it is possible that not all tools are placed on the environment. \
            The x coordinate can only be -1 to 1. If x is negative, then it is on the right side. If x is positive, then it is on the left side. If you see x coordinate is increasing, that means the ball is moving to the right. The y coordinate is from -1 to 1. The bottom is -1 and the top is 1. The values increase from bottom to top. \
            The message {message} tells you the blue ball and the red ball's trajectory over time, corresponding to the images. \
            First, you must say objects and their position shown on {obj_pos}. \
            Answer the following questions: \
            1) If the message {message} say something about the tools and there are already some tools: Go to question 2. \
                If the message {message} does not say anything about the the relative positions of the tools to the objects and there is no orange tools placed: which tool (Ramp or Cannon) should be placed to help the blue ball reach the red ball? If the red ball is above the blue ball in the beginning, you need to place a cannon to shoot the blue ball. If the red ball is below the blue ball, you do not need a cannon.\
                You must also say what direction the blue ball needs to move toward (left or right) to reach the red ball. If the red ball is on the left of the blue ball in the beginning, then the blue ball needs to move to the left. If the red ball is on the right of the blue ball in the beginning, then the blue ball needs to move to the right. \
                    If you choose a ramp: You need to place the tool by saying its relative direction ('top', 'bottom', 'left' or 'right') to the blue ball and one other object that is closest to the blue ball at this point. \
                    If you choose a cannon: You only need to say the direction the blue ball needs to move toward the red ball (only answer 'left' or 'right'). \
            2) Observe and say, you must describe the all orange tools and their orders. After interacting with the last tool, you must say which direction is the blue ball moving toward (left or right)? \
            3) Given the {message}, is the red ball in the left or right side of this last placed tool? \
                If the blue ball is moving to the left but the red ball is on the right of the tool, or if the blue ball is moving to the right but the red ball is on the left of the tool, that means the tool is not helping the blue ball move toward the red ball. You must say whether you should move last placed tool up or down so that the ball can collide with the tool and move toward the red ball. You must say I need to adjust the tool by moving the tool up or down so that the blue ball can completely hit it. Exit here and do not answer any questions. \
                If the blue ball is moving to the left and the red ball is on the left of the tool, or if the blue ball is moving to the right and the red ball is on the right of the tool, then the last placed tool indeed make the blue ball toward the red ball, move to the next question.\
            4) In the last few frames before the blue ball disappears on the screen, you have access to use tools to help the blue ball change its moving direction toward the red ball. Which one tool would you chooose to place to help the blue ball changes its direction? You must describe the functions of all tools from {tools}.\
                You must say is the red ball on the left or right of the blue ball in the end? \
                You also must say whether the blue ball now needs to move to the left or right. If the red ball in the end is on the left of the blue ball, then the blue ball needs to move to the left. If the red ball is on the right, then the blue ball needs to move to the right. \
            5) If you choose a ramp: You need to place the tool by saying its relative direction ('top', 'bottom', 'left' or 'right') to the red ball and one other object that is closest to the blue ball at this point ( not including the horizonal blue ball on which the red ball is resting). \
                Remember if the red ball in the end is on the left of the blue ball, then the tool should be placed on the right of the red ball. If the blue ball is on the bottom of the other object, then the tool should be placed on the bottom of the other object. )\
               If you choose a fixed_hexagon or a cannon: You only need to place the tool by saying its relative direction ('top', 'bottom', 'left' or 'right') to the red ball.  Remember if the red ball in the end is on the right of the blue ball, then the tool should be placed on the left of the red ball. If the red ball in the end is on the left of the blue ball, then the tool should be placed on the right of the red ball.",
            image_documents=image_documents,
        )


    return (response_1.text)





def main():
    message = 'the blue ball has not reached the red ball. The red ball has not reached the goal. The red ball is on the right of the blue ball in the beginning. The red ball is below the blue ball in the beginning. The red ball is on the right of the blue ball in the end. The red ball is above the blue ball in the end. The trajectory of the blue ball is: The blue ball is at (-0.09999999999999987, 0.7087301587301587) now. It moves vertically down at (-0.09999999999999987, 0.5828042328042327). The blue ball is at (-0.09999999999999987, 0.5828042328042327) now. It moves vertically down at (-0.09999999999999987, 0.3722222222222231). The blue ball is at (-0.09999999999999987, 0.3722222222222231) now. It moves to the left and down at (-0.03487327815423669, 0.15765997206250715). The blue ball is at (-0.03487327815423669, 0.15765997206250715) now. It moves to the left and down at (0.11796292562355526, -0.03264268285235705). The blue ball is at (0.11796292562355526, -0.03264268285235705) now. It moves to the left and down at (0.2707991294013472, -0.30760142242330546). The blue ball is at (0.2707991294013472, -0.30760142242330546) now. It moves to the left and down at (0.42363533317913893, -0.6672162466503384). The trajectory of the red ball is: The red ball is at (-0.5, -0.301904761904762) now. It moves vertically down at (-0.5, -0.3047750289351855). The red ball is at (-0.5, -0.3047750289351855) now. It remains at the same position. The red ball is at (-0.5, -0.3047750289351855) now. It remains at the same position. The red ball is at (-0.5, -0.3047750289351855) now. It remains at the same position. The red ball is at (-0.5, -0.3047750289351855) now. It remains at the same position. The red ball is at (-0.5, -0.3047750289351855) now. It remains at the same position. The red ball is at (-0.5, -0.3047750289351855) now. It remains at the same position. The red ball is at (-0.5, -0.3047750289351855) now. It remains at the same position. The red ball is at (-0.5, -0.3047750289351855) now. It remains at the same position. The red ball is at (-0.5, -0.3047750289351855) now. It remains at the same position. The red ball is at (-0.5, -0.3047750289351855) now. It remains at the same position. The red ball is at (-0.5, -0.3047750289351855) now. It remains at the same position. The red ball is at (-0.5, -0.3047750289351855) now. It remains at the same position. The red ball is at (-0.5, -0.3047750289351855) now. It remains at the same position. The red ball is at (-0.5, -0.3047750289351855) now. It remains at the same position. The red ball is at (-0.5, -0.3047750289351855) now. It remains at the same position. The red ball is at (-0.5, -0.3047750289351855) now. It remains at the same position. The red ball is at (-0.5, -0.3047750289351855) now. It remains at the same position. The red ball is at (-0.5, -0.3047750289351855) now. It remains at the same position. The red ball is at (-0.5, -0.3047750289351855) now. It remains at the same position. The red ball is at (-0.5, -0.3047750289351855) now. It remains at the same position. The red ball is at (-0.5, -0.3047750289351855) now. It remains at the same position. The red ball is at (-0.5, -0.3047750289351855) now. It remains at the same position. The red ball is at (-0.5, -0.3047750289351855) now. It remains at the same position. The red ball is at (-0.5, -0.3047750289351855) now. It remains at the same position. The red ball is at (-0.5, -0.3047750289351855) now. It remains at the same position. The red ball is at (-0.5, -0.3047750289351855) now. It remains at the same position. The red ball is at (-0.5, -0.3047750289351855) now. It remains at the same position. The red ball is at (-0.5, -0.3047750289351855) now. It remains at the same position. The red ball is at (-0.5, -0.3047750289351855) now. It remains at the same position. The goal is on the left of the red ball in the end. The goal is placed at: [0, -0.59]. The wall is placed at: [-0.2, 0]'
    #message ='the blue ball has not reached the red ball. The red ball has not reached the goal. the red ball is on the left of the blue ball in the beginning. The red ball is below the blue ball in the beginning. The red ball is on the left of the blue ball in the end. The red ball is below the blue ball in the end. The trajectory of the blue ball is: The blue ball is at (-0.6, 0.8587301587301586) now. It moves vertically down at (-0.6, 0.7328042328042326). The blue ball is at (-0.6, 0.7328042328042326) now. It moves vertically down at (-0.6, 0.5222222222222226). The blue ball is at (-0.6, 0.5222222222222226) now. It moves vertically down at (-0.6, 0.22698412698412773). The blue ball is at (-0.6, 0.22698412698412773) now. It moves vertically up at (-0.6, 0.31471904761457825). The blue ball is at (-0.6, 0.31471904761457825) now. It moves vertically up at (-0.6, 0.3697455026410328). The blue ball is at (-0.6, 0.3697455026410328) now. It moves vertically down at (-0.6, 0.3401158730114029). The blue ball is at (-0.6, 0.3401158730114029) now. It moves vertically down at (-0.6, 0.22583015872568812). The blue ball is at (-0.6, 0.22583015872568812) now. It moves vertically up at (-0.6, 0.2355737513142282). The blue ball is at (-0.6, 0.2355737513142282) now. It moves vertically down at (-0.6, 0.21282242856290567). The blue ball is at (-0.6, 0.21282242856290567) now. It moves vertically down at (-0.6, 0.2028356560761333). The blue ball is at (-0.6, 0.2028356560761333) now. It moves vertically down at (-0.6, 0.19531250792798538). The blue ball is at (-0.6, 0.19531250792798538) now. It moves vertically down at (-0.6, 0.1952236775553413). The blue ball is at (-0.6, 0.1952236775553413) now. It remains at the same position. The trajectory of the red ball is: The red ball is at (0.10000000000000009, -0.36190476190476195) now. It moves vertically down at (0.10000000000000009, -0.36477502893518543). The red ball is at (0.10000000000000009, -0.36477502893518543) now. It remains at the same position. The red ball is at (0.10000000000000009, -0.36477502893518543) now. It remains at the same position. The red ball is at (0.10000000000000009, -0.36477502893518543) now. It remains at the same position. The red ball is at (0.10000000000000009, -0.36477502893518543) now. It remains at the same position. The red ball is at (0.10000000000000009, -0.36477502893518543) now. It remains at the same position. The red ball is at (0.10000000000000009, -0.36477502893518543) now. It remains at the same position. The red ball is at (0.10000000000000009, -0.36477502893518543) now. It remains at the same position. The red ball is at (0.10000000000000009, -0.36477502893518543) now. It remains at the same position. The red ball is at (0.10000000000000009, -0.36477502893518543) now. It remains at the same position. The red ball is at (0.10000000000000009, -0.36477502893518543) now. It remains at the same position. The red ball is at (0.10000000000000009, -0.36477502893518543) now. It remains at the same position. The red ball is at (0.10000000000000009, -0.36477502893518543) now. It remains at the same position. The goal is on the right of the red ball in the end. The goal is placed at: [-0.8, -0.89]. The floor is placed at: [-0.5, 0.1]'
    pos = 'The goal is placed at: [0, -0.59]. The wall is placed at: [-0.2, 0]'

    response = generate_response(message, pos)
    print(response)

if __name__ == "__main__":
    main()